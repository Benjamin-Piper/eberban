# eberban PEG grammar - v0.45
# =============================

# GRAMMAR
# main text rule
text <- (free_interjection / free_parenthetical)* paragraphs? spaces? EOF?

# text structure
paragraphs <- paragraph (&PU_clause paragraph)*
paragraph <- PU_clause? paragraph_unit (&(PA_clause / PO_clause) paragraph_unit)*

paragraph_unit <- paragraph_unit_erased / paragraph_unit_1
paragraph_unit_erased <- paragraph_unit_1 CU_clause
paragraph_unit_1 <- definition / sentence

arguments_list <- (KI_clause / GI_clause)* PI_clause

definition <- PO_clause defined scope
defined <- GI_clause / freeform_variable / predicate_compound / predicate_root
sentence <- PA_clause_elidible scope

# scope
scope <- arguments_list? scope_1

scope_1 <- scope_sequence / scope_2
scope_sequence <- scope_sequence_item (BU_clause scope_sequence_item)+
scope_sequence_item <- scope_2

scope_2 <- chaining

# chaining and explicit switches
chaining <- (chaining_neg / chaining_unit)+
chaining_neg <- BI_clause chaining
chaining_unit <- predicate ve_scope?
ve_scope <- ve_scope_first ve_scope_next* VEI_clause_elidible
ve_scope_first <- BI_clause? VE_clause scope 
ve_scope_next <- BI_clause? FE_clause scope

# predicate unit
predicate <- predicate_1 free*
predicate_1 <- (SE_clause !SE_clause / ZI_clause)* predicate_2
predicate_2 <- BA_clause / MI_clause / predicate_quote / predicate_variable / predicate_scope / predicate_borrowing / predicate_root / predicate_number / predicate_compound

predicate_root <- spaces? root
predicate_number <- spaces? number
predicate_compound <- spaces? compound
predicate_borrowing <- borrowing_group
predicate_scope <- PE_clause scope PEI_clause_elidible

# quotes
predicate_quote <- grammatical_quote / one_word_quote / foreign_quote
grammatical_quote <- CA_clause text CAI_clause
one_word_quote <- CE_clause spaces? (native_word / compound / borrowing)
foreign_quote <- CO_clause spaces? foreign_quote_open space_char foreign_quote_content pause_char foreign_quote_close
foreign_quote_content <- (!(pause_char foreign_quote_close) .)*

# numbers
number <- TI_clause+ BE_clause_elidible

# borrowings
borrowing_group <- (spaces? borrowing)+ BE_clause_elidible

# variables
predicate_variable <- BO_clause? (KI_clause / GI_clause / spaces? freeform_variable)

# free affixes
override <- DU_clause predicate_1 # avoid nested free

free <- free_metadata / free_parenthetical / free_subscript / free_interjection
free_metadata <- DA_clause
free_subscript <- DI_clause number
free_parenthetical <- DO_clause text DOI_clause
free_interjection <- DE_clause predicate_1 # avoid nested free

# PARTICLES CLAUSES
BA_clause  <- spaces? BA                   # inline argument
BE_clause  <- spaces? BE                   # miscellaneous terminator
BI_clause  <- spaces? BI  free*            # wide-scope negation
BO_clause  <- spaces? BO                   # variable assignement
BU_clause  <- spaces? BU                   # sequence separator
                                           #
DA_clause  <- spaces? DA                   # free metadata
DE_clause  <- spaces? DE                   # free interjection
DI_clause  <- spaces? DI                   # free subscript
DO_clause  <- spaces? DO                   # free parenthetical starter
DOI_clause <- spaces? DOI                  # free parenthetical terminator
DU_clause  <- spaces? DU                   # free particle override
                                           #
SE_clause  <- spaces? SE  override?        # chaining override
ZI_clause  <- spaces? ZI  override?        # predicate transformation
VE_clause  <- spaces? VE  override? free*  # explicit switch + VE-scope
FE_clause  <- spaces? FE  override? free*  # next explicit switch
VEI_clause <- spaces? VEI                  # VE-scope terminator
                                           #
GI_clause  <- spaces? GI                   # predicate variables
KI_clause  <- spaces? KI                   # individual variables
MI_clause  <- spaces? MI                   # discourse predicates
                                           #
PA_clause  <- spaces? PA  free*            # sentence starter
PE_clause  <- spaces? PE  free*            # predicate scope starter
PEI_clause <- spaces? PEI                  # predicate scope elidible terminator
PI_clause  <- spaces? PI                   # arguments sequence terminator
PO_clause  <- spaces? PO  free*            # definition starter
PU_clause  <- spaces? PU  free*            # paragraph marker
                                           #
TI_clause  <- spaces? TI                   # numbers/digits
                                           #
CA_clause  <- spaces? CA                   # grammatical quote starter
CAI_clause <- spaces? CAI                  # grammatical quote terminator
CE_clause  <- spaces? CE                   # one word quote
CO_clause  <- spaces? CO                   # foreign quote
                                           #
CU_clause  <- spaces? CU                   # paragraph unit eraser

BE_clause_elidible  <- BE_clause?
PA_clause_elidible  <- PA_clause?
PEI_clause_elidible <- PEI_clause?
VEI_clause_elidible <- VEI_clause?

# PARTICLE FAMILIES
BA    <- &particle                   (b a)              &post_word
BE    <- &particle                   (b &e hieaou)      &post_word
BI    <- &particle                   (b i)              &post_word
BO    <- &particle                   (b o)              &post_word
BU    <- &particle                   (b &u hieaou)      &post_word
CA    <- &particle !(CAI &post_word) (c &a hieaou)      &post_word
CAI   <- &particle                   (c a i)            &post_word
CE    <- &particle                   (c &e hieaou)      &post_word
CO    <- &particle                   (c &o hieaou)      &post_word
CU    <- &particle                   (c u)              &post_word
DA    <- &particle                   (d &a hieaou)      &post_word
DE    <- &particle                   (d &e hieaou)      &post_word
DI    <- &particle                   (d i)              &post_word
DO    <- &particle                   (d o)              &post_word
DOI   <- &particle                   (d o i)            &post_word
DU    <- &particle                   (d u)              &post_word
FE    <- &particle                   (f hieaou)         &post_word
GI    <- &particle                   (g hieaou)         &post_word
KI    <- &particle                   (k hieaou)         &post_word
MI    <- &particle                   (m hieaou)         &post_word
PA    <- &particle                   (p &a hieaou)      &post_word
PE    <- &particle                   (p e)              &post_word
PEI   <- &particle                   (p e i)            &post_word
PI    <- &particle                   (p &i hieaou)      &post_word
PO    <- &particle                   (p &o hieaou)      &post_word
PU    <- &particle                   (p &u hieaou)      &post_word
SE    <- &particle                   (s hieaou)         &post_word
TI    <- &particle                   (t hieaou) / digit &post_word
VE    <- &particle !(VEI &post_word) (v hieaou)         &post_word
VEI   <- &particle                   (v e i)            &post_word
ZI    <- &particle                   (z hieaou)         &post_word


# MORPHOLOGY
# - Forein text quoting
foreign_quote_open <- native_word
foreign_quote_word <- (!pause_char .)+ 
foreign_quote_close <- native_word

# - Compounds
compound <- (compound_2 / compound_3 / compound_n)
compound_2 <- e compound_word compound_word
compound_3 <- a compound_word compound_word compound_word
compound_n <- o (!compound_n_end compound_word)+ compound_n_end
compound_n_end <- spaces o spaces
compound_word <- spaces? (borrowing / native_word)

# - Free-form words
freeform_variable <- i (spaces &i / hyphen !i) freeform_content freeform_end
borrowing <- u (spaces &u / hyphen !u) freeform_content freeform_end
freeform_content <- (initial_pair / consonant / h)? hieaou (consonant_cluster hieaou)* sonorant?
freeform_end <- (pause_char / space_char / EOF)

# - Native words
native_word <- root / particle
particle <- !sonorant particle_1 &post_word
root <- !sonorant (root_1 / root_2 / root_3) &post_word

particle_1 <- consonant hieaou !medial_pair

root_1 <- consonant hieaou ((medial_pair / hyphen sonorant) hieaou)+ sonorant?
root_2 <- consonant hieaou sonorant
root_3 <- initial_pair hieaou ((medial_pair / hyphen sonorant) hieaou)* sonorant?

# - Legal clusters
hieaou <- ieaou (hyphen h ieaou)*
ieaou <- vowel (hyphen vowel)*

consonant_cluster <- (consonant_cluster_1 / consonant_cluster_2) !consonant
consonant_cluster_1 <- &medial_pair !sonorant consonant hyphen initial_pair
consonant_cluster_2 <- medial_pair / sonorant? hyphen (initial_pair / !sonorant consonant) / sonorant hyphen 

medial_pair <- !initial medial_patterns
medial_patterns <- (medial_n / medial_fv / medial_plosive)
medial_n <- (m / liquid) hyphen n / n hyphen liquid
medial_fv <- (f / v) hyphen (plosive / sibilant / m)
medial_plosive <- plosive hyphen (f / v / plosive / m)

# initial pairs cannot contain an hyphen
initial_pair <- &initial consonant consonant !consonant
# we need to support hyphenation to use `!initial` in `medial_pair`
initial <- ((plosive / f / v) hyphen sibilant / sibilant hyphen other / sibilant hyphen sonorant / other hyphen sonorant)

other <- (p / b) !n / (t / d) !n !l / v / f / k / g / m / n !liquid
plosive <- t / d / k / g / p / b
sibilant <- c / s / j / z
sonorant <- n / r / l

consonant <- (voiced / unvoiced / liquid / nasal) 
nasal <- m / n
liquid <- l / r
voiced <- b / d / g / v / z / j
unvoiced <- p / t / k / f / s / c

vowel <- i / e / a / o / u

# Legal letters
i <- [iI]+ # <LEAF>
e <- [eE]+ # <LEAF>
a <- [aA]+ # <LEAF>
o <- [oO]+ # <LEAF>
u <- [uU]+ # <LEAF>

h <- [hH]+ # <LEAF>
n <- [nN]+ # <LEAF>
r <- [rR]+ # <LEAF>
l <- [lL]+ # <LEAF>

m <- [mM]+ # <LEAF>
p <- [pP]+ !voiced # <LEAF>
b <- [bB]+ !unvoiced # <LEAF>
f <- [fF]+ !voiced # <LEAF>
v <- [vV]+ !unvoiced # <LEAF>
t <- [tT]+ !voiced # <LEAF>
d <- [dD]+ !unvoiced # <LEAF>
s <- [sS]+ !c !voiced # <LEAF>
z <- [zZ]+ !j !unvoiced # <LEAF>
c <- [cC]+ !s !voiced # <LEAF>
j <- [jJ]+ !z !unvoiced # <LEAF>
g <- [gG]+ !unvoiced # <LEAF>
k <- [kK]+ !voiced # <LEAF>

# - Spaces / Pause
post_word <- (pause_char &vowel) / !sonorant &consonant / spaces
spaces <- space_char+ hesitation? (pause_char &vowel)? / pause_char &vowel / EOF
hesitation <- (n (space_char+ / EOF))+

# - Special characters
hyphen <- (hyphen_char [\n\r]*)? # hyphens + line break support
hyphen_char <- [\u2010\u2014\u002D]
pause_char <- (['’`]) !pause_char
space_char <- !(pause_char / digit / hyphen_char / [a-zA-Z]) .
digit <- [0-9] # <LEAF2>
EOF <- !.